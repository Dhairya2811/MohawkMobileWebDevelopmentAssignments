<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment 2</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <style>
        #map{
            height: 90vh;
            width: 100vw;
        }
        #feature{
            background-color: rgb(53, 53, 53);   
            width: 100%;
        }
        #buttons{
            padding: 10px;   
            width: 100%;      
        }
        #pac-input{
            width: 75%;
            margin-top: 12px;
        }
        #sidebar {
            flex-basis: 40rem;
            flex-grow: 2;
            padding: 1rem;
            max-width: 40rem;
            height: 90vh;
            box-sizing: border-box;
            overflow:scroll;
            display: none;
        }
        #container {
            height: 100%;
            display: flex;
        }
    </style>
</head>
<body>
    <div id="feature">
        <div>
            <input id="pac-input" class="form-control" type="text" placeholder="Search" />
        </div>
        <div id="buttons" class="d-flex container justify-content-end"">
            <div class="form-check">
                <input class="btn btn-secondary" type="button" value="Show All" id="showallbtn" />
            </div>
            <div class="form-check">
                <input class="btn btn-info" type="button" value="Water Falls" id="waterfallbtn" />
            </div>
            <div class="form-check">
                <input class="btn btn-warning" type="button" value="Education Institution" id="educationalbtn" />
            </div>
            <div class="form-check">
                <input class="btn btn-primary disabled" type="button" value="Get Direction" id="getDirectionBtn" />
            </div>
        </div>
    </div>
    <div id="container">
        <div id="map"></div>
        <div id="sidebar"></div>
    </div>

    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAB2gE7215cKAtMfOK6mfhbCnNztVD-als&callback=initMap&libraries=places&v=weekly"
      defer"></script>
    <script>        
        var waterfall_markers = [];
        var educational_markers = [];
        var markers = [];
        var userLocation = [];
        var currentMarkerLocation = [];
        var userLocationMarker = [];
        function initMap(){

            // setting up the map with center in Hamilton, ON and with the zoom level of 12.
            map=new google.maps.Map(document.getElementById("map"),{
                center:{
                    lat: 43.2387,
                    lng: -79.8881
                },
                zoom: 12,
            });

            // getting the location of the user.
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position)=>{
                    userLocation.push(position.coords.latitude);
                    userLocation.push(position.coords.longitude);
                    // adding the user location marker after 0.5 sec.
                    setTimeout(()=>{
                        var info = `<div>
                            <h4>Your Location</h4>
                        </div>`;
                        const marker = new google.maps.Marker({
                            map,
                            position: {lat: position.coords.latitude, lng: position.coords.longitude},
                            animation: google.maps.Animation.DROP,
                            buborek: info,
                        });
                        userLocationMarker.push(marker);
                        google.maps.event.addListener(marker, "click", function(){
                            infoWindow.setContent(this.buborek);
                            infoWindow.open({
                                anchor: marker,
                                map,
                            });
                        });
                    }, 500);                    
                });
            } else {
                x.innerHTML = "Geolocation is not supported by this browser.";
            }

            // clear all the markers and show only educational institutions' markers
            function educationFilter(){
                clearSearchBox();
                clearMarker();
                directionsRenderer.setMap(null);
                document.getElementById("sidebar").style.display = "none";
                educational_markers.forEach(element => {
                    element.setMap(map);
                });
            };

            // clear all the markers and show only waterfalls' markers
            function waterFallFilter(){
                clearSearchBox();
                clearMarker();
                directionsRenderer.setMap(null);
                document.getElementById("sidebar").style.display = "none";
                waterfall_markers.forEach(element => {
                    element.setMap(map);
                });
            };

            // clear all the markers and show only educational institutions' markers and waterfalls' markers
            function showall(){
                clearMarker();
                map.setZoom(12);
                clearSearchBox();
                document.getElementById("sidebar").style.display = "none";
                directionsRenderer.setMap(null);
                var location = new google.maps.LatLng(43.2387, -79.8881);
                map.setCenter(location);
                educational_markers.forEach(element => {
                    element.setMap(map);
                });
                waterfall_markers.forEach(element => {
                    element.setMap(map);
                });
            }          
            
            // this function will erase all the markers including the searched place's marker.
            function clearMarker(){
                waterfall_markers.forEach(element => {
                    element.setMap(null);
                });
                educational_markers.forEach(element=>{
                    element.setMap(null);
                });
                markers.forEach(element=>{
                    element.setMap(null);
                });
            }

            
            // getting the route from the user location to the destination
            const directionsRenderer = new google.maps.DirectionsRenderer();
            const directionsService = new google.maps.DirectionsService();
            directionsRenderer.setMap(map);
            directionsRenderer.setPanel(document.getElementById("sidebar"));
            document.getElementById("getDirectionBtn").addEventListener("click", ()=>{
                if(currentMarkerLocation.length !== 0){
                    getDirectionClick();
                }
            });
            function getDirectionClick(){
                document.getElementById("sidebar").style.display = "block";
                calculateAndDisplayRoute(directionsService, directionsRenderer);
            }
            function calculateAndDisplayRoute(directionsService, directionsRenderer) {
                const start = new google.maps.LatLng(userLocation[0], userLocation[1]);
                const end = new google.maps.LatLng(currentMarkerLocation[0], currentMarkerLocation[1]);

                directionsService
                    .route({
                    origin: start,
                    destination: end,
                    travelMode: google.maps.TravelMode.DRIVING,
                    })
                    .then((response) => {
                    directionsRenderer.setDirections(response);
                    })
                    .catch((e) => window.alert("Directions request failed due to " + status));
            }

            // adding the click listener for waterfall button to show only waterfalls 
            document.getElementById("waterfallbtn").addEventListener("click", function(){
                waterFallFilter();
            });

            // adding the click listener for educational button to show only educational institutions
            document.getElementById("educationalbtn").addEventListener("click", function(){
                educationFilter();
            });

            // show all the markers accept searched place marker
            document.getElementById("showallbtn").addEventListener("click", function(){
                showall();
            });

            // preparing for the info window.
            const infoWindow = new google.maps.InfoWindow();

            
            // fetching data about the educational institution and showing them on the map with the green markers 
            // also adding those markers on the array names educational_markers.
            fetch("./data/educationalInstitutionData.json")
            .then(res => res.json())
            .then(async res =>{
                await res.features.forEach( element => {
                    var point = {lat:parseFloat(element.properties.LATITUDE), lng: parseFloat(element.properties.LONGITUDE)}
                    var info = `<div>
                            <h4>${element.properties.NAME}</h4>
                            <p>${element.properties.ADDRESS}, ${element.properties.COMMUNITY}.</p>
                        </div>`;
                    const marker = new google.maps.Marker({
                        animation: google.maps.Animation.DROP,
                        position: point,
                        icon: "http://maps.google.com/mapfiles/ms/icons/pink-dot.png",
                        map: map,
                        buborek: info
                    });
                    educational_markers.push(marker);
                    google.maps.event.addListener(marker, "click", function(){
                        document.getElementById("getDirectionBtn").classList.remove("disabled");
                        currentMarkerLocation = [];
                        currentMarkerLocation.push(parseFloat(element.properties.LATITUDE));
                        currentMarkerLocation.push(parseFloat(element.properties.LONGITUDE));
                        infoWindow.setContent(this.buborek);
                        infoWindow.open({
                            anchor: marker,
                            map,
                        });
                    });
                    google.maps.event.addListener(infoWindow, "closeclick", function(){
                        document.getElementById("sidebar").style.display = "none";
                        directionsRenderer.setMap(null);
                        document.getElementById("getDirectionBtn").classList.add("disabled");
                        currentMarkerLocation = [];
                    })
                });
            });
            
            // fetching data about the waterfalls and showing them on the map with the green markers 
            // also adding those markers on the array names waterfall_markers.
            fetch("./data/waterfallsData.json")
            .then(res => res.json())
            .then(res =>{
                res.features.forEach( element => {
                    var point = {lat:parseFloat(element.properties.LATITUDE), lng: parseFloat(element.properties.LONGITUDE)};
                    
                    var info = `<div>
                            <h3>${element.properties.NAME}</h4>
                            <p>${element.properties.COMMUNITY}.</p>
                        </div>`;
                    
                    const marker = new google.maps.Marker({
                        animation: google.maps.Animation.DROP,
                        position: point,
                        icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
                        map: map,
                        buborek: info
                    });
                    waterfall_markers.push(marker);
                    google.maps.event.addListener(marker, "click", function(){
                        document.getElementById("getDirectionBtn").classList.remove("disabled");
                        currentMarkerLocation = [];
                        currentMarkerLocation.push(parseFloat(element.properties.LATITUDE));
                        currentMarkerLocation.push(parseFloat(element.properties.LONGITUDE));
                        infoWindow.setContent(this.buborek);
                        infoWindow.open({
                            anchor: marker,
                            map,
                        });
                    });
                    google.maps.event.addListener(infoWindow, "closeclick", function(){
                        document.getElementById("sidebar").style.display = "none";
                        directionsRenderer.setMap(null);
                        document.getElementById("getDirectionBtn").classList.add("disabled");
                        currentMarkerLocation = [];
                    })
                });
            });

            // search input for the custom search for the places.
            const input = document.getElementById("pac-input");
            input.addEventListener("input", ()=>{
                if(input.value.length == 0){
                    clearMarker();
                    showall();
                    map.setZoom(12);
                    var location = new google.maps.LatLng(43.2387, -79.8881);
                    map.setCenter(location);
                }
            });
            function clearSearchBox(){
                input.value = "";
            }
            const searchBox = new google.maps.places.SearchBox(input);
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
            // Bias the SearchBox results towards current map's viewport.
            map.addListener("bounds_changed", () => {
                searchBox.setBounds(map.getBounds());
            });
            searchBox.addListener("places_changed", () => {
                const places = searchBox.getPlaces();
                
                clearMarker();
                if (places.length == 0) {
                    return;
                }
                const bounds = new google.maps.LatLngBounds();

                places.forEach((place) => {
                if (!place.geometry || !place.geometry.location) {
                    return;
                }
                var info = `<div>
                    <h6>${places[0].formatted_address}</h6>
                </div>`;

                const icon = {
                    url: place.icon,
                    size: new google.maps.Size(71, 71),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(17, 34),
                    scaledSize: new google.maps.Size(25, 25),
                };
                var marker = new google.maps.Marker({
                    map,
                    icon,
                    title: place.name,
                    position: place.geometry.location,
                    buborek: info,
                });
                markers.push(marker);
                google.maps.event.addListener(marker, "click", function(){
                    document.getElementById("getDirectionBtn").classList.remove("disabled");
                    currentMarkerLocation = [];
                    currentMarkerLocation.push(parseFloat(marker.getPosition().lat()));
                    currentMarkerLocation.push(parseFloat(marker.getPosition().lng()));
                    infoWindow.setContent(this.buborek);
                    infoWindow.open({
                        anchor: marker,
                        map,
                    });
                });
                google.maps.event.addListener(infoWindow, "closeclick", function(){
                    document.getElementById("sidebar").style.display = "none";
                    directionsRenderer.setMap(null);
                    document.getElementById("getDirectionBtn").classList.add("disabled");
                    currentMarkerLocation = [];
                })
                if (place.geometry.viewport) {
                    bounds.union(place.geometry.viewport);
                } else {
                    bounds.extend(place.geometry.location);
                }
                
                });
                map.fitBounds(bounds);
            });
        }
    </script>
</body>
</html>